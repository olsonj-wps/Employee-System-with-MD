<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>WorkerSync</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --cyan:   #00f0ff;
  --lime:   #c8ff57;
  --rose:   #ff2d6f;
  --blue:   #3d7fff;
  --g-bg:   rgba(255,255,255,0.038);
  --g-bdr:  rgba(255,255,255,0.065);
  --g-top:  rgba(255,255,255,0.12);
  --t1:     #ddeaff;
  --t2:     rgba(175,200,255,0.6);
  --t3:     rgba(135,165,230,0.35);
  --r:      11px;
  --r-sm:   7px;
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
html,body{min-height:100vh;overflow-x:hidden;}

body {
  font-family:'Syne',sans-serif;
  color:var(--t1);
  background:
    radial-gradient(ellipse 100% 90% at 0% 50%,  rgba(20,0,80,0.6)  0%,transparent 65%),
    radial-gradient(ellipse 80%  70% at 100% 5%,  rgba(0,55,170,0.45)0%,transparent 60%),
    radial-gradient(ellipse 60%  60% at 50% 100%, rgba(0,110,130,0.2)0%,transparent 55%),
    linear-gradient(170deg,#020009 0%,#04000f 30%,#021017 60%,#04001a 100%);
  background-attachment:fixed;
  font-size:13px;
}

/* orbs */
.orbs{position:fixed;inset:0;pointer-events:none;z-index:0;overflow:hidden;}
.orb{position:absolute;border-radius:50%;filter:blur(80px);}
.o1{width:60vw;height:60vw;background:radial-gradient(circle,rgba(30,0,160,0.18),transparent 70%);top:-15%;left:-20%;animation:of 28s ease-in-out infinite;}
.o2{width:45vw;height:45vw;background:radial-gradient(circle,rgba(0,80,200,0.14),transparent 70%);bottom:10%;right:-15%;animation:of 22s ease-in-out infinite;animation-delay:-11s;}
@keyframes of{0%,100%{transform:translate(0,0)scale(1)}33%{transform:translate(5%,-5%)scale(1.05)}66%{transform:translate(-4%,6%)scale(0.95)}}

/* shell */
.shell{position:relative;z-index:1;padding:10px 10px 20px;}

/* glass */
.g{
  background:var(--g-bg);
  backdrop-filter:blur(24px)saturate(160%);
  -webkit-backdrop-filter:blur(24px)saturate(160%);
  border:1px solid var(--g-bdr);
  border-top-color:var(--g-top);
  border-left-color:rgba(255,255,255,0.08);
  border-radius:var(--r);
  box-shadow:0 8px 28px rgba(0,0,0,0.38),inset 0 1px 0 rgba(255,255,255,0.06);
}

/* header */
.hd{text-align:center;padding:10px 4px 8px;}
.hd h1{font-size:1.15rem;font-weight:800;letter-spacing:0.12em;text-transform:uppercase;color:var(--cyan);text-shadow:0 0 22px rgba(0,240,255,0.65),0 0 50px rgba(0,240,255,0.2);}
.hd small{display:block;font-size:0.6rem;letter-spacing:0.18em;text-transform:uppercase;color:var(--t3);font-family:'DM Mono',monospace;margin-top:2px;}
.launch-btn{display:block;width:100%;margin-top:8px;padding:6px 10px;border-radius:var(--r-sm);font:700 0.65rem/1 'Syne',sans-serif;letter-spacing:0.1em;text-transform:uppercase;text-align:center;cursor:pointer;background:rgba(0,240,255,0.07);border:1px solid rgba(0,240,255,0.22);color:var(--cyan);transition:all 0.2s;}
.launch-btn:hover{background:rgba(0,240,255,0.13);box-shadow:0 0 14px rgba(0,240,255,0.18);}
.launch-btn i{margin-right:5px;}

/* accordion */
.acc{margin-bottom:7px;}
.acc-hd{
  display:flex;align-items:center;gap:7px;
  padding:9px 12px;cursor:pointer;user-select:none;
  border-radius:var(--r);
  font:700 0.7rem/1 'Syne',sans-serif;letter-spacing:0.1em;text-transform:uppercase;
  color:var(--t2);transition:all 0.2s;
}
.acc-hd i.ic{font-size:0.82rem;color:var(--t3);}
.acc-hd .arr{margin-left:auto;font-size:0.65rem;color:var(--t3);transition:transform 0.25s;}
.acc.open .acc-hd{color:var(--cyan);background:rgba(0,240,255,0.06);border:1px solid rgba(0,240,255,0.2);text-shadow:0 0 10px rgba(0,240,255,0.5);}
.acc.open .acc-hd i.ic{color:var(--cyan);}
.acc.open .acc-hd .arr{transform:rotate(180deg);color:var(--cyan);}
.acc-hd:not(.acc.open .acc-hd){border:1px solid transparent;}
.acc-hd:hover:not(.acc.open .acc-hd){background:rgba(255,255,255,0.04);border-color:rgba(255,255,255,0.07);}
.acc-body{display:none;padding:10px 10px 12px;}
.acc.open .acc-body{display:block;animation:fadeIn 0.2s;}

/* forms */
.fg{margin-bottom:9px;}
label{display:block;font:500 0.6rem/1 'DM Mono',monospace;letter-spacing:0.12em;text-transform:uppercase;color:var(--t2);margin-bottom:4px;}
label i{margin-right:3px;font-size:0.65rem;}
input,select{
  width:100%;padding:7px 9px;border-radius:var(--r-sm);
  font:400 0.82rem/1 'Syne',sans-serif;
  background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);
  color:var(--t1);outline:none;transition:all 0.2s;
}
input::placeholder{color:var(--t3);font-size:0.78rem;}
select option{background:#09001a;color:var(--t1);}
input:focus,select:focus{border-color:rgba(0,240,255,0.35);box-shadow:0 0 0 2px rgba(0,240,255,0.07);}
input[type="date"]::-webkit-calendar-picker-indicator{filter:invert(0.7)sepia(1)hue-rotate(175deg)saturate(1.5);cursor:pointer;}

/* buttons */
.btn{padding:7px 13px;border-radius:var(--r-sm);font:700 0.65rem/1 'Syne',sans-serif;letter-spacing:0.1em;text-transform:uppercase;cursor:pointer;border:none;display:inline-flex;align-items:center;gap:5px;transition:all 0.2s;position:relative;overflow:hidden;white-space:nowrap;}
.bp{background:linear-gradient(135deg,#1438d0,#00b0cc);color:#fff;box-shadow:0 2px 14px rgba(0,130,200,0.25);}
.bp:hover{transform:translateY(-1px);box-shadow:0 0 18px rgba(0,200,230,0.4);}
.bsm{padding:4px 8px;font-size:0.6rem;border-radius:5px;}
.be{background:rgba(61,127,255,0.1);border:1px solid rgba(61,127,255,0.25);color:#7da4ff;}
.be:hover{background:rgba(61,127,255,0.17);}
.bd{background:rgba(255,45,111,0.1);border:1px solid rgba(255,45,111,0.25);color:#ff7da0;}
.bd:hover{background:rgba(255,45,111,0.17);}
.bq{background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.07);color:var(--t2);}
.bq:hover{background:rgba(255,255,255,0.08);}
.bw{display:block;width:100%;}
.btn.loading{opacity:0.55;cursor:not-allowed;pointer-events:none;}
.btn.loading::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent 25%,rgba(255,255,255,0.12)50%,transparent 75%);animation:sh 1.2s infinite;}
@keyframes sh{0%{transform:translateX(-100%)}100%{transform:translateX(200%)}}

/* quick actions */
.qa{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:9px;}

/* chips */
.chip{display:inline-block;padding:2px 7px;border-radius:20px;font:700 0.6rem/1.4 'DM Mono',monospace;letter-spacing:0.06em;text-transform:uppercase;}
.cp{background:rgba(200,255,87,0.1);color:#c8ff57;border:1px solid rgba(200,255,87,0.25);}
.ca{background:rgba(255,45,111,0.1);color:#ff7da0;border:1px solid rgba(255,45,111,0.25);}
.ch{background:rgba(255,107,43,0.1);color:#ff9a6b;border:1px solid rgba(255,107,43,0.25);}
.co{background:rgba(0,240,255,0.07);color:var(--cyan);border:1px solid rgba(0,240,255,0.25);}
.ct{background:rgba(155,93,229,0.1);color:#c77dff;border:1px solid rgba(155,93,229,0.25);}

/* tables */
.tw{overflow-x:auto;margin-top:9px;border-radius:var(--r-sm);border:1px solid var(--g-bdr);}
table{width:100%;border-collapse:collapse;min-width:240px;}
thead tr{background:rgba(0,240,255,0.04);border-bottom:1px solid rgba(0,240,255,0.1);}
th{padding:8px 9px;text-align:left;font:600 0.6rem/1 'DM Mono',monospace;letter-spacing:0.13em;text-transform:uppercase;color:var(--cyan);}
td{padding:7px 9px;font-size:0.78rem;color:var(--t1);border-bottom:1px solid rgba(255,255,255,0.04);}
tr:last-child td{border-bottom:none;}
tbody tr:hover td{background:rgba(255,255,255,0.025);}
tfoot td{font:700 0.78rem/1 'DM Mono',monospace;color:var(--lime);text-shadow:0 0 8px rgba(200,255,87,0.3);border-top:1px solid rgba(200,255,87,0.16);padding-top:8px;}
.date-row td{padding:7px 9px;font:600 0.62rem/1 'DM Mono',monospace;letter-spacing:0.1em;text-transform:uppercase;color:var(--cyan);background:rgba(0,240,255,0.04);border-top:1px solid rgba(0,240,255,0.09);}
.sep-row td{padding:0;}
.sep-row hr{border:none;border-top:1px solid rgba(255,255,255,0.04);}

/* messages */
.msg{margin-top:8px;padding:7px 9px;border-radius:var(--r-sm);font-size:0.75rem;font-weight:600;}
.ok{background:rgba(0,210,100,0.07);color:#00e676;border:1px solid rgba(0,210,100,0.18);}
.er{background:rgba(255,45,111,0.07);color:#ff7da0;border:1px solid rgba(255,45,111,0.18);}

/* modal */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.72);backdrop-filter:blur(10px);z-index:100;align-items:center;justify-content:center;}
.modal.open{display:flex;animation:fadeIn 0.18s;}
.mbox{width:92%;max-width:320px;padding:16px;position:relative;animation:su 0.2s ease;}
.mbox h4{font-size:0.72rem;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:var(--cyan);text-shadow:0 0 10px rgba(0,240,255,0.4);margin-bottom:11px;display:flex;align-items:center;gap:6px;}
.mc{position:absolute;top:10px;right:12px;background:none;border:none;color:var(--t2);font-size:1rem;cursor:pointer;transition:color 0.2s;padding:0;line-height:1;}
.mc:hover{color:var(--rose);}

/* divider */
.dv{height:1px;background:linear-gradient(90deg,transparent,rgba(0,240,255,0.1),transparent);margin:10px 0;}

/* worker list item */
.witem{display:flex;align-items:center;justify-content:space-between;padding:7px 0;border-bottom:1px solid rgba(255,255,255,0.04);}
.witem:last-child{border-bottom:none;}
.wname{font-size:0.82rem;color:var(--t1);}
.wpay{font:400 0.72rem/1 'DM Mono',monospace;color:var(--lime);margin-right:8px;}

@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes su{from{transform:translateY(14px);opacity:0}to{transform:translateY(0);opacity:1}}
</style>
</head>
<body>

<div class="orbs">
  <div class="orb o1"></div>
  <div class="orb o2"></div>
</div>

<div class="shell">
  <div class="hd">
    <h1 id="appTitle">WorkerSync</h1>
    <small id="appSub">Workforce Manager</small>
    <button class="launch-btn" id="launchBtn" onclick="launchWebApp()">
      <i class="fas fa-external-link-alt"></i> Open Full App
    </button>
  </div>

  <!-- ─── WORKERS ─── -->
  <div class="acc g" id="accWorkers">
    <div class="acc-hd" onclick="toggleAcc('accWorkers')">
      <i class="fas fa-users ic"></i> Workers
      <i class="fas fa-chevron-down arr"></i>
    </div>
    <div class="acc-body">
      <h4 style="font-size:0.65rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--t2);margin-bottom:9px;font-family:'DM Mono',monospace"><i class="fas fa-user-plus" style="margin-right:4px"></i> Add / Update</h4>
      <div class="fg"><label><i class="fas fa-user"></i> Name</label><input type="text" id="sWorkerName" placeholder="Full name"></div>
      <div class="fg"><label><i class="fas fa-coins"></i> Daily Pay Rate</label><input type="number" id="sPayRate" placeholder="0.00" min="0" step="0.01"></div>
      <button class="btn bp bw" id="sWorkerBtn" onclick="sHandleWorker()"><i class="fas fa-save"></i> Save Worker</button>
      <div id="sWorkerMsg"></div>
      <div class="dv"></div>
      <h4 style="font-size:0.65rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--t2);margin-bottom:7px;font-family:'DM Mono',monospace"><i class="fas fa-list" style="margin-right:4px"></i> Current Workers</h4>
      <div id="sWorkerList"></div>
    </div>
  </div>

  <!-- ─── ATTENDANCE ─── -->
  <div class="acc g" id="accAttend">
    <div class="acc-hd" onclick="toggleAcc('accAttend')">
      <i class="fas fa-calendar-check ic"></i> Attendance
      <i class="fas fa-chevron-down arr"></i>
    </div>
    <div class="acc-body">
      <h4 style="font-size:0.65rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--t2);margin-bottom:9px;font-family:'DM Mono',monospace"><i class="fas fa-calendar-plus" style="margin-right:4px"></i> Record</h4>
      <div class="fg"><label><i class="fas fa-calendar"></i> Date</label><input type="date" id="sAttDate"></div>
      <div class="qa">
        <button class="btn bsm be" onclick="sMarkAll('1')"><i class="fas fa-check-double"></i> Present</button>
        <button class="btn bsm bd" onclick="sMarkAll('0')"><i class="fas fa-times"></i> Absent</button>
        <button class="btn bsm bq" onclick="sMarkAll('')"><i class="fas fa-eraser"></i> Clear</button>
      </div>
      <div id="sAttFields"></div>
      <button class="btn bp bw" style="margin-top:10px" id="sAttBtn" onclick="sSubmitAttend()"><i class="fas fa-check"></i> Submit</button>
      <div id="sAttMsg"></div>

      <div class="dv"></div>
      <h4 style="font-size:0.65rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--t2);margin-bottom:7px;font-family:'DM Mono',monospace"><i class="fas fa-edit" style="margin-right:4px"></i> Correct</h4>
      <div class="fg"><label><i class="fas fa-calendar"></i> Date</label><input type="date" id="sCorDate"></div>
      <div class="fg"><label><i class="fas fa-search"></i> Worker</label><input type="text" id="sCorWorker" placeholder="Name..."></div>
      <button class="btn bp bw" id="sSearchBtn" onclick="sSearch()"><i class="fas fa-search"></i> Search</button>
      <div class="tw">
        <table>
          <thead><tr><th>Date</th><th>Worker</th><th>Status</th><th></th></tr></thead>
          <tbody id="sCorData"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ─── REPORTS ─── -->
  <div class="acc g" id="accReports">
    <div class="acc-hd" onclick="toggleAcc('accReports')">
      <i class="fas fa-chart-bar ic"></i> Reports
      <i class="fas fa-chevron-down arr"></i>
    </div>
    <div class="acc-body">
      <div class="fg"><label><i class="fas fa-calendar-alt"></i> From</label><input type="date" id="sStartDate"></div>
      <div class="fg"><label><i class="fas fa-calendar-alt"></i> To</label><input type="date" id="sEndDate"></div>
      <button class="btn bp bw" id="sReportBtn" onclick="sGenReport()"><i class="fas fa-chart-line"></i> Generate</button>

      <div class="dv"></div>
      <div style="font-size:0.62rem;letter-spacing:0.14em;text-transform:uppercase;color:var(--t2);margin-bottom:7px;font-family:'DM Mono',monospace"><i class="fas fa-receipt" style="margin-right:4px"></i> Pay Report</div>
      <div class="tw">
        <table>
          <thead><tr><th>Worker</th><th>Days</th><th>Pay</th></tr></thead>
          <tbody id="sReportData"></tbody>
          <tfoot><tr id="sTotalRow" style="display:none">
            <td colspan="2" style="text-align:right;font-size:0.6rem;color:var(--t2);letter-spacing:0.1em;text-transform:uppercase;font-family:'DM Mono',monospace">Total</td>
            <td id="sTotalCell"></td>
          </tr></tfoot>
        </table>
      </div>
      <div class="dv"></div>
      <div style="font-size:0.62rem;letter-spacing:0.14em;text-transform:uppercase;color:var(--t2);margin-bottom:7px;font-family:'DM Mono',monospace"><i class="fas fa-history" style="margin-right:4px"></i> History</div>
      <div class="tw">
        <table><tbody id="sHistData"></tbody></table>
      </div>
    </div>
  </div>
</div>

<!-- Edit Attend Modal -->
<div id="sEditModal" class="modal">
  <div class="mbox g">
    <button class="mc" onclick="sCM('sEditModal')"><i class="fas fa-times"></i></button>
    <h4><i class="fas fa-edit"></i> Edit</h4>
    <div id="sModalContent"></div>
  </div>
</div>

<!-- Edit Worker Modal -->
<div id="sWModal" class="modal">
  <div class="mbox g">
    <button class="mc" onclick="sCM('sWModal')"><i class="fas fa-times"></i></button>
    <h4><i class="fas fa-user-edit"></i> Edit Worker</h4>
    <div id="sWModalContent"></div>
  </div>
</div>

<script>
let sCA = null;
let sCW = null;
let sCX = '₹';
let webAppUrl = '';

document.addEventListener('DOMContentLoaded', () => {
  sLoadConfig();
  sLoadWorkers();
  sLoadAttWorkers();
  // open Workers by default
  toggleAcc('accWorkers');
  const t = new Date().toISOString().split('T')[0];
  ['sAttDate','sStartDate','sEndDate'].forEach(id => { document.getElementById(id).value = t; });
  // get webapp URL for launch button
  google.script.run
    .withSuccessHandler(url => { webAppUrl = url; })
    .withFailureHandler(() => {})
    .getWebAppUrl();
});

function launchWebApp() {
  if (webAppUrl) { window.open(webAppUrl, '_blank'); }
  else { alert('Deploy this project as a web app first, then the button will open it.'); }
}

/* ── Accordion ─────────────────────────────── */
function toggleAcc(id) {
  const el = document.getElementById(id);
  const wasOpen = el.classList.contains('open');
  document.querySelectorAll('.acc').forEach(a => a.classList.remove('open'));
  if (!wasOpen) el.classList.add('open');
}

/* ── Config ─────────────────────────────────── */
function sLoadConfig() {
  google.script.run
    .withSuccessHandler(c => {
      sCX = c.currencySymbol || '₹';
      if (c.appName)    document.getElementById('appTitle').textContent = c.appName;
      if (c.companyName) document.getElementById('appSub').textContent = c.companyName;
    })
    .withFailureHandler(() => {})
    .getConfig();
}

/* ── Workers ─────────────────────────────────── */
function sHandleWorker() {
  const btn  = document.getElementById('sWorkerBtn');
  const name = document.getElementById('sWorkerName').value.trim();
  const pay  = document.getElementById('sPayRate').value;
  if (!name) { sMsg('sWorkerMsg','Name required.',false); return; }
  if (!pay||isNaN(pay)||+pay<0) { sMsg('sWorkerMsg','Valid pay rate required.',false); return; }
  sLoad(btn, true);
  google.script.run
    .withSuccessHandler(() => {
      sMsg('sWorkerMsg','Worker saved.',true);
      document.getElementById('sWorkerName').value='';
      document.getElementById('sPayRate').value='';
      sLoadWorkers(); sLoadAttWorkers(); sLoad(btn,false);
    })
    .withFailureHandler(e => { sMsg('sWorkerMsg','Error: '+e.message,false); sLoad(btn,false); })
    .addOrUpdateWorker(name, pay);
}

function sLoadWorkers() {
  google.script.run
    .withSuccessHandler(ws => {
      document.getElementById('sWorkerList').innerHTML = ws.length
        ? ws.map(w => `
          <div class="witem">
            <div>
              <div class="wname">${sEsc(w[0])}</div>
              <div class="wpay">${sCX}${(+w[1]).toLocaleString()}/day</div>
            </div>
            <div style="display:flex;gap:4px">
              <button class="btn bsm be" onclick="sOpenEditWorker('${sEsc(w[0])}',${w[1]})"><i class="fas fa-edit"></i></button>
              <button class="btn bsm bd" onclick="sDelWorker('${sEsc(w[0])}')"><i class="fas fa-trash"></i></button>
            </div>
          </div>`).join('')
        : '<p style="color:var(--t3);font-size:0.78rem;font-style:italic;padding:6px 0">No workers yet.</p>';
    })
    .withFailureHandler(e => alert('Error: '+e.message))
    .getWorkers();
}

function sOpenEditWorker(name, pay) {
  sCW = { orig: name };
  document.getElementById('sWModalContent').innerHTML = `
    <div class="fg"><label>Name</label><input type="text" id="sewName" value="${sEsc(name)}"></div>
    <div class="fg"><label>Daily Pay Rate</label><input type="number" id="sewPay" value="${pay}" min="0" step="0.01"></div>
    <button class="btn bp bw" id="sswBtn" onclick="sSaveWorker()"><i class="fas fa-save"></i> Save</button>`;
  document.getElementById('sWModal').classList.add('open');
}

function sSaveWorker() {
  const btn = document.getElementById('sswBtn');
  const n = document.getElementById('sewName').value.trim();
  const p = document.getElementById('sewPay').value;
  if (!n) { alert('Name required.'); return; }
  sLoad(btn, true);
  google.script.run
    .withSuccessHandler(() => { sCM('sWModal'); sLoadWorkers(); sLoadAttWorkers(); sLoad(btn,false); })
    .withFailureHandler(e => { alert('Error: '+e.message); sLoad(btn,false); })
    .editWorker(sCW.orig, n, p);
}

function sDelWorker(name) {
  if (!confirm(`Delete "${name}"? Attendance records remain.`)) return;
  google.script.run
    .withSuccessHandler(() => { sLoadWorkers(); sLoadAttWorkers(); })
    .withFailureHandler(e => alert('Error: '+e.message))
    .deleteWorker(name);
}

/* ── Attendance ──────────────────────────────── */
function sLoadAttWorkers() {
  google.script.run
    .withSuccessHandler(names => {
      document.getElementById('sAttFields').innerHTML = names.length
        ? names.map(n => `
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;align-items:center;margin-bottom:6px">
            <label style="margin-bottom:0;font-size:0.78rem;color:var(--t1);text-transform:none;letter-spacing:0">${sEsc(n)}</label>
            <select class="sas" data-worker="${sEsc(n)}">
              <option value="">—</option>
              <option value="2">Two (2.0)</option>
              <option value="1.5">1.5</option>
              <option value="1">Present</option>
              <option value="0.5">Half</option>
              <option value="0">Absent</option>
            </select>
          </div>`).join('')
        : '<p style="color:var(--t3);font-size:0.78rem;font-style:italic">Add workers first.</p>';
    })
    .withFailureHandler(e => alert('Error: '+e.message))
    .getWorkerNames();
}

function sMarkAll(v) { document.querySelectorAll('.sas').forEach(s => s.value = v); }

function sSubmitAttend() {
  const btn  = document.getElementById('sAttBtn');
  const date = document.getElementById('sAttDate').value;
  if (!date) { sMsg('sAttMsg','Select a date.',false); return; }
  const data = {};
  document.querySelectorAll('.sas').forEach(s => { if (s.value !== '') data[s.dataset.worker] = s.value; });
  if (!Object.keys(data).length) { sMsg('sAttMsg','No status selected.',false); return; }
  sLoad(btn, true);
  google.script.run
    .withSuccessHandler(() => { sMsg('sAttMsg','Saved.',true); sMarkAll(''); sLoad(btn,false); })
    .withFailureHandler(e => { sMsg('sAttMsg','Error: '+e.message,false); sLoad(btn,false); })
    .updateAttendance(date, data);
}

/* ── Correction ──────────────────────────────── */
function sSearch() {
  const btn = document.getElementById('sSearchBtn');
  sLoad(btn, true);
  google.script.run
    .withSuccessHandler(rs => { sRenderCor(rs); sLoad(btn,false); })
    .withFailureHandler(e => { alert('Error: '+e.message); sLoad(btn,false); })
    .getAttendanceRecords(document.getElementById('sCorDate').value, document.getElementById('sCorWorker').value);
}

function sRefreshCor() {
  google.script.run
    .withSuccessHandler(sRenderCor)
    .withFailureHandler(e => alert('Error: '+e.message))
    .getAttendanceRecords(document.getElementById('sCorDate').value, document.getElementById('sCorWorker').value);
}

function sRenderCor(rs) {
  document.getElementById('sCorData').innerHTML = rs.length
    ? rs.map(r => `<tr>
        <td style="font-family:'DM Mono',monospace;font-size:0.7rem">${r.date}</td>
        <td>${sEsc(r.worker)}</td>
        <td>${sChip(r.status)}</td>
        <td><div style="display:flex;gap:3px">
          <button class="btn bsm be" onclick="sOpenEditAtt('${r.date}','${sEsc(r.worker)}',${r.status})"><i class="fas fa-edit"></i></button>
          <button class="btn bsm bd" onclick="sDelRecord('${r.date}','${sEsc(r.worker)}')"><i class="fas fa-trash"></i></button>
        </div></td></tr>`).join('')
    : '<tr><td colspan="4" style="color:var(--t3);font-size:0.75rem;font-style:italic;text-align:center;padding:12px">No records.</td></tr>';
}

function sOpenEditAtt(date, worker, status) {
  sCA = { date, worker };
  document.getElementById('sModalContent').innerHTML = `
    <p style="font-size:0.7rem;color:var(--t2);margin-bottom:10px;font-family:'DM Mono',monospace">
      <span style="color:var(--cyan)">${date}</span> &mdash; ${sEsc(worker)}
    </p>
    <div class="fg">
      <label>Status</label>
      <select id="sNewStatus">
        <option value="2"   ${status==2  ?'selected':''}>Two Days (2.0)</option>
        <option value="1.5" ${status==1.5?'selected':''}>One &amp; Half (1.5)</option>
        <option value="1"   ${status==1  ?'selected':''}>Present (1.0)</option>
        <option value="0.5" ${status==0.5?'selected':''}>Half Day (0.5)</option>
        <option value="0"   ${status==0  ?'selected':''}>Absent (0)</option>
      </select>
    </div>
    <button class="btn bp bw" id="sSaveAttBtn" onclick="sSaveAtt()"><i class="fas fa-save"></i> Save</button>`;
  document.getElementById('sEditModal').classList.add('open');
}

function sSaveAtt() {
  const btn = document.getElementById('sSaveAttBtn');
  sLoad(btn, true);
  google.script.run
    .withSuccessHandler(() => { sCM('sEditModal'); sRefreshCor(); sLoad(btn,false); })
    .withFailureHandler(e => { alert('Error: '+e.message); sLoad(btn,false); })
    .updateAttendanceRecord(sCA.date, sCA.worker, document.getElementById('sNewStatus').value);
}

function sDelRecord(date, worker) {
  if (!confirm(`Delete record for ${worker} on ${date}?`)) return;
  google.script.run
    .withSuccessHandler(sRefreshCor)
    .withFailureHandler(e => alert('Error: '+e.message))
    .deleteAttendanceRecord(date, worker);
}

/* ── Reports ─────────────────────────────────── */
function sGenReport() {
  const btn = document.getElementById('sReportBtn');
  const s   = document.getElementById('sStartDate').value;
  const e   = document.getElementById('sEndDate').value;
  if (!s||!e)  { alert('Select both dates.'); return; }
  if (s > e)   { alert('Start before end.'); return; }
  sLoad(btn, true);
  google.script.run
    .withSuccessHandler(d => { sRenderReport(d); sLoad(btn,false); })
    .withFailureHandler(e => { alert('Error: '+e.message); sLoad(btn,false); })
    .calculateTotalPay(s, e);
}

function sRenderReport(data) {
  const rb = document.getElementById('sReportData');
  const ta = document.getElementById('sTotalCell');
  const tr = document.getElementById('sTotalRow');
  if (data.error) { rb.innerHTML=`<tr><td colspan="3" style="color:var(--rose)">${data.error}</td></tr>`; tr.style.display='none'; return; }
  if (!data.reportData||!data.reportData.length) {
    rb.innerHTML='<tr><td colspan="3" style="color:var(--t3);font-style:italic;text-align:center;padding:12px">No data.</td></tr>';
    tr.style.display='none';
  } else {
    rb.innerHTML = data.reportData.map(r =>
      `<tr><td>${r.name}</td><td style="font-family:'DM Mono',monospace">${r.days}</td><td style="font-family:'DM Mono',monospace">${sCX}${r.pay.toFixed(2)}</td></tr>`
    ).join('');
    ta.textContent = `${sCX}${data.totalAmount.toFixed(2)}`;
    tr.style.display = 'table-row';
  }
  const hb = document.getElementById('sHistData');
  if (!data.attendanceHistory||!data.attendanceHistory.length) { hb.innerHTML='<tr><td style="color:var(--t3);font-size:0.75rem;font-style:italic;padding:10px">No history.</td></tr>'; return; }
  const g = data.attendanceHistory.reduce((a,e) => { (a[e.date]=a[e.date]||[]).push(e); return a; }, {});
  hb.innerHTML = Object.keys(g).sort((a,b)=>new Date(a)-new Date(b)).flatMap(d => [
    `<tr class="date-row"><td colspan="3">${d}</td></tr>`,
    ...g[d].map(e => `<tr><td></td><td>${sEsc(e.worker)}</td><td>${sChip(e.status)}</td></tr>`),
    `<tr class="sep-row"><td colspan="3"><hr></td></tr>`
  ]).join('');
}

/* ── Helpers ─────────────────────────────────── */
function sCM(id) {
  document.getElementById(id).classList.remove('open');
  if (id==='sEditModal') sCA=null;
  if (id==='sWModal')    sCW=null;
}
function sChip(s) {
  const m={'0':['Absent','ca'],'0.5':['Half','ch'],'1':['Present','cp'],'1.5':['1.5D','co'],'2':['2 Days','ct']};
  const [l,c]=m[String(s)]||['?','ca'];
  return `<span class="chip ${c}">${l}</span>`;
}
function sMsg(id,msg,ok) {
  const el=document.getElementById(id);
  el.innerHTML=`<div class="msg ${ok?'ok':'er'}">${msg}</div>`;
  setTimeout(()=>{if(el)el.innerHTML='';},3500);
}
function sLoad(btn,v) { btn.classList.toggle('loading',v); }
function sEsc(s) { return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
</script>
</body>
</html>
